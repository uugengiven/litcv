<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Divide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.1/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@1.9.2/dist/tsparticles.min.js"
    integrity="sha256-5kED68Spy7K2CEbfu4CjV92DmZR5ZQFUoIR5qmPzZWg=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="fonts/fonts.css" />
  <link rel="stylesheet" href="d3.css" />

  <script src="//unpkg.com/three"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <script src="js/paths-particles.js"></script>

</head>

<body onload="init()" class="gradient-body">
  <div class="particles gradient-body" id="tsparticles"></div>

  <!-- SITE HEADER -->
  <header>
    <h1 class="gt-america">Digital <span class="black-white">Divide</span></h1>
    <a href="#" class="menu-toggle">
      <svg width="50" height="50" viewBox="0 0 74 74" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="37" cy="37" r="37" fill="#E9EEF3" />
        <rect x="20" y="30" width="35" height="2" fill="#131313" class="menu-top" />
        <rect x="20" y="42" width="35" height="2" fill="#131313" class="menu-bottom" />
      </svg>
    </a>
  </header>

  <!-- MENU NAVIGATION -->
  <!-- These two nav tags are for the menu animation -->
  <nav class="fake-back"></nav>
  <nav class="fake-mid"></nav>

  <!-- Actual navigation -->
  <nav>
    <div class="internal">
      <a class="gt-america" href="characters.html">Characters</a>
      <a class="gt-america" href="story.html">Story</a>
      <a class="gt-america" href="cast.html">Cast and Crew</a>
      <a class="gt-america" href="news.html">News</a>
      <a class="gt-america" href="contact.html">Contact</a>
    </div>
    <div class="social">
      <a class="" href="#">Twitter</a>
      <a class="" href="#">Facebook</a>
      <a class="" href="#">Instagram</a>
    </div>
  </nav>
  </section>
  <section>
    <div id="3d-graph">
    </div>
  </section>
  <article class="snackbar_hidden" id="snackbar-container">
    <!-- temp tags until styled -->
    <img class="snackbar-icon" src="./images/icons/close-icon-circle.png" alt="close" title="close">
    <section class="diagonal-blocks">
      <div class="block block--left"></div>
      <div class="hamburger-btn hidden">
        <div class="hamburger"></div>
      </div>
      <section class="select-options hidden">
        <div>one</div>
        <div>two</div>
      </section>
      <div class="block block--right"></div>
    </section>
    <section class="snackbar-controls">
      <div>
        <img class="control-icon control-icon--prev" src="images/icons/back.png" alt="back button icon" title="previous">
      </div>
      <div>
        <img class="control-icon control-icon--play" src="images/icons/play.png" alt="play button icon" title="play">
      </div>
      <div>
        <img class="control-icon control-icon--next" src="images/icons/forward.png" alt="forward button icon" title="next">
      </div>
    </section>
  </article>

  <script>
    const init = () => {
      particles();
    };
  </script>

  <script src="dd-data/episodes.js"></script>
  <!-- TODO: move to external file -->
  <script>
    // Selectors for snackbar and diagonal blocks inside snackbar
    const snackbar = document.getElementById('snackbar-container');
    const blockLeft = document.querySelector('.block--left');
    const blockRight = document.querySelector('.block--right');
    // Selectors for snack bar control icons
    const prevBtn = document.querySelector('.control-icon--prev');
    const nextBtn = document.querySelector('.control-icon--next');
    const playBtn = document.querySelector('.control-icon--play')
    // Selector for hamburger button in snackbar
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    var isHamburgerMenuOpen = false;
    // Selector for selector options in snackbar
    const selectOptions = document.querySelector('.select-options');
    // all nodes data
    const allNodes = data.nodes;
    // all links data
    const allLinks = data.links;
    // global vars because we need global access to these: (storyPath is path of episode links for each character)
    var storyPath = [];
    var storyPathIndex = 0;

    // Function increments through storyPath array and sets/resets classes based on position in array
    nextBtn.onclick = function() {
      // checks if last item of array
      if (storyPathIndex === (storyPath.length - 1)) {
        return;
      }
      // increment storyPath index
      storyPath[++storyPathIndex];
      // removes active class on nextBtn if at last item in storyPath array
      storyPathIndex === (storyPath.length - 1) ? nextBtn.classList.remove('active') : null;
      // changes opacity for right text block in snackbar
      blockRight.classList.add('active');
      // changes opacity for play icon in snackbar
      playBtn.classList.add('active');
      // changes opacity for prev icon in snackbar
      prevBtn.classList.add('active');
      // sets text content for episode in right diagonal block
      blockRight.textContent = storyPath[storyPathIndex].source.title;
      // gets next target x,y,z and repositions camera
      let node = storyPath[storyPathIndex].source;
      const distance = 35;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
    }
    
    // Function decrements through storyPath array and sets/resets classes based on position in array
    prevBtn.onclick = function() {
      // checks if first item of array
      if (storyPathIndex === 0) {
        return;
      }
      if (storyPathIndex === 1) {
        // resets right block text if at first element of array and going back to character node
        blockRight.textContent = '';
      }
      // decrement storyPath index
      storyPath[--storyPathIndex];
      // reset/set classes and text for snackbar blocks/controls
      storyPathIndex === 0 
      ? blockRight.classList.remove('active') 
      & prevBtn.classList.remove('active')
      & playBtn.classList.remove('active')
      : blockRight.textContent = storyPath[storyPathIndex].source.title;
      nextBtn.classList.add('active');
      // gets next target x,y,z and repositions camera
      let node = storyPath[storyPathIndex].source;
      const distance = 35;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
    }

    // Function adds hamburger animation and toggles character path options 
    hamburgerBtn.addEventListener("click", () => {
      if(isHamburgerMenuOpen){
        isHamburgerMenuOpen = !isHamburgerMenuOpen;
        hamburgerBtn.classList.remove("open");
        selectOptions.classList.add('hidden')
      }
      else{
        isHamburgerMenuOpen = !isHamburgerMenuOpen;
        hamburgerBtn.classList.add("open");
        selectOptions.classList.remove('hidden')
      }
    });

    // 3D graph 
    const elem = document.getElementById('3d-graph');
    const Graph = ForceGraph3D()
      (elem)
      .graphData(data)
      .backgroundColor('#ffffff00')
      .nodeLabel('title')
      .linkDirectionalParticles('value')
      .linkDirectionalParticleSpeed(.005)
      .linkColor('linkColor')
      .linkOpacity(1)
      .linkCurvature('linkCurvature')
      .linkCurveRotation('curveRotation')
      .linkDirectionalParticleWidth(1.125)
      .linkWidth('width')
      .linkResolution(6)
      .nodeThreeObject(({
        img,
        type,
        id,
        size
      }) => {
        const imgTexture = new THREE.TextureLoader().load(`./images/episodes/${img}`);
        const material = new THREE.SpriteMaterial({
          map: imgTexture
        });
        const sprite = new THREE.Sprite(material);
        if (type == "Character") {
          sprite.scale.set(size, size);
        } 
        else {
          sprite.scale.set(16, 9);
        }

        return sprite;
      })
      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
      // Aim at node from outside it
      .onNodeClick(node => {
        // checks to see if snackbar is open and toggles it
        snackbar.classList.contains('snackbar_hidden') ?
          snackbar.classList.remove('snackbar_hidden') & snackbar.classList.add('snackbar_show') :
          null;

        // conditional for character versus episode 
        if (node.type === "Character") {
          // builds storyPath array based on node id and characterPath property in json
          storyPath = allLinks.filter(item => item.characterPath === node.id);
          // resets storyPath index
          storyPathIndex = 0;
          // toggle hamburger var
          isHamburgerMenuOpen = false;
          // hide hamburger btn
          hamburgerBtn.classList.add('hidden');
          // hide snackbar select options
          selectOptions.classList.add('hidden')
          // resets classes on snackbar control icons
          prevBtn.classList.remove('active')
          playBtn.classList.remove('active')
          // adds active class to next button
          nextBtn.classList.add('active');
          // resets for storyPathIndex and text content
          blockRight.classList.remove('active');
          blockRight.textContent = '';
          // Sets colors/text content for diagonal boxes in snackbar
          blockLeft.style.backgroundColor = node.primaryColor
          blockLeft.textContent = node.title;
        }
        if (node.type === "Episode") {
          // resets storyPath array which is path of links for each character
          storyPath = [];
          // resets storyPath index
          storyPathIndex = 0;
          // show hamburger button
          hamburgerBtn.classList.remove('hidden')
          // sets snackbar right box to episode title
          blockRight.textContent = node.title; 
          // resets snackbar left box to empty string
          blockLeft.textContent = 'Choose Path';
          // sets snackbar left box to default color
          blockLeft.style.backgroundColor = '#e2e2e2';
          // reset/set classes on snackbar right box and snackbar controls   
          blockRight.classList.add('active');         
          nextBtn.classList.remove('active');
          prevBtn.classList.remove('active');
          playBtn.classList.add('active');
          // get associated characters
          // TODO: should this be a var??
          let associatedCharactersArray = node.associatedCharacters;
          console.log(associatedCharactersArray);
          // filters associatedCharactersArray against allNodes to get characters objects needed
          let filteredNodes = allNodes.filter(item => associatedCharactersArray.includes(item.id))
          console.log(filteredNodes);
        }
        const distance = 35;
        const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
      });
  </script>
  <script src="js/menu.js"></script>
  <script src="js/snackbarToggle.js"></script>
</body>

</html>

<!-- 
for filtering 
https://stackoverflow.com/questions/34901593/how-to-filter-an-array-from-all-elements-of-another-array -->


<!-- select options -->
<!-- make diagonal blocks relative position -->
<!-- background-color: lightgrey;
    height: 70px;
    width: calc(100% - 20px);
    position: absolute;
    bottom: 0;
    z-index: 9;
    display: flex;
    justify-content: space-evenly; -->

    <!-- use avatar images instead of names? -->
    <!-- slide in from left??? -->