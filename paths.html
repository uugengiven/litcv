<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Divide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.1/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@1.9.2/dist/tsparticles.min.js"
    integrity="sha256-5kED68Spy7K2CEbfu4CjV92DmZR5ZQFUoIR5qmPzZWg=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="fonts/fonts.css" />
  <link rel="stylesheet" href="d3.css" />

  <script src="//unpkg.com/three"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <script src="js/orbits.js"></script>
  <script src="js/paths-particles.js"></script>

</head>

<body onload="init()" class="gradient-body">
  <div class="particles gradient-body" id="tsparticles"></div>

  <!-- SITE HEADER -->
  <header>
    <!-- TODO: if they like this make it a class -->
    <h1 class="gt-america">Digital <span class="black-white">Divide</span></h1>
    <a href="#" class="menu-toggle">
      <svg width="50" height="50" viewBox="0 0 74 74" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="37" cy="37" r="37" fill="#E9EEF3" />
        <rect x="20" y="30" width="35" height="2" fill="#131313" class="menu-top" />
        <rect x="20" y="42" width="35" height="2" fill="#131313" class="menu-bottom" />
      </svg>
    </a>
  </header>

  <!-- MENU NAVIGATION -->
  <!-- These two nav tags are for the menu animation -->
  <nav class="fake-back"></nav>
  <nav class="fake-mid"></nav>

  <!-- Actual navigation -->
  <nav>
    <div class="internal">
      <a class="gt-america" href="characters.html">Characters</a>
      <a class="gt-america" href="story.html">Story</a>
      <a class="gt-america" href="cast.html">Cast and Crew</a>
      <a class="gt-america" href="news.html">News</a>
      <a class="gt-america" href="contact.html">Contact</a>
    </div>
    <div class="social">
      <a class="" href="#">Twitter</a>
      <a class="" href="#">Facebook</a>
      <a class="" href="#">Instagram</a>
    </div>
  </nav>
  </section>
  <section>
    <div id="3d-graph">
    </div>
  </section>
  <article class="snackbar_hidden" id="snackbar-container">
    <!-- temp tags until styled -->
    <img class="snackbar-icon" src="./images/icons/close-icon.png" alt="close" onclick="closeSnackbar()">
    <section class="diagonal-blocks">
      <div class="block block--left"></div>
      <div class="block block--right" onclick="snackbarReposition()"></div>
    </section>
    <section class="snackbar-controls">
      <div>
        <img class="control-icon" src="images/icons/back.png" alt="back button icon">
      </div>
      <div>
        <img class="control-icon" src="images/icons/play.png" alt="play button icon">
      </div>
      <div>
        <img class="control-icon" src="images/icons/forward.png" alt="forward button icon">
      </div>
    </section>
  </article>

  <script>
    const init = () => {
      particles();
    };
  </script>

  <script src="dd-data/episodes.js"></script>
  <script>
    const elem = document.getElementById('3d-graph');

    const Graph = ForceGraph3D()
      (elem)
      .graphData(data)
      .backgroundColor('#ffffff00')
      .nodeLabel('title')
      .linkDirectionalParticles('value')
      // .linkDirectionalParticleSpeed(d => d.value * 0.001)
      .linkDirectionalParticleSpeed(.005)
      .linkColor('linkColor')
      .linkOpacity(1)
      .linkCurvature('linkCurvature')
      .linkCurveRotation('curveRotation')
      .linkDirectionalParticleWidth(1.125)
      .linkWidth('width')
      .linkResolution(6)
      .nodeThreeObject(({
        img,
        type,
        id,
        size
      }) => {
        const imgTexture = new THREE.TextureLoader().load(`./images/episodes/${img}`);
        const material = new THREE.SpriteMaterial({
          map: imgTexture
        });
        const sprite = new THREE.Sprite(material);
        if (type == "Character") {
          sprite.scale.set(size, size);
        } 
        else {
          sprite.scale.set(16, 9);
        }

        return sprite;
      })
      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
      .onNodeClick(node => {
        // Aim at node from outside it
        // Gets all node data
        let allNodes = data.nodes;
        const snackbar = document.getElementById('snackbar-container');
        const primaryCharacter = document.querySelector('.block--left');
        const episodeTitle = document.querySelector('.block--right');

        // checks to see if snackbar is open and toggles it
        snackbar.classList.contains('snackbar_hidden') ?
          snackbar.classList.remove('snackbar_hidden') & snackbar.classList.add('snackbar_show') :
          null;

        // conditional for character versus episode
        // because there might be different properties for characters/episodes
        if (node.type === "Character") {
          // Sets colors/text content for diagonal boxes in snackbar
          primaryCharacter.style.backgroundColor = node.primaryColor
          primaryCharacter.textContent = node.title;
          // Sets next episode text in right block of snackbar diagonal blocks
          episodeTitle.textContent = node.recommendedEpisode;
          // Sets data attribute on snackbar block to give it access to that value
          episodeTitle.setAttribute("data-episode", node.recommendedEpisodeID);
          // Finds next node info based on recommended episode property passed from nodes JSON
          let nextTarget = allNodes.find(item => item.id === node.recommendedEpisodeID);
          // Sets x,y,z of node as data attributes on diagonal block in snackbar
          episodeTitle.setAttribute('data-x', nextTarget.x);
          episodeTitle.setAttribute('data-y', nextTarget.y);
          episodeTitle.setAttribute('data-z', nextTarget.z);
        }
        if (node.type === "Episode") {
          // Sets background color of left diagonal block in snackbar
          primaryCharacter.style.backgroundColor = node.primaryColor
          // Sets text of left diagonal block in snackbar
          primaryCharacter.textContent = node.primaryCharacter;
          // Sets text of right diagonal block in snackbar
          episodeTitle.textContent = node.title;         
        }
        const distance = 40;
        const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
      });
  </script>
  <script>
    // Grabs data-attribute to use for repositioning graph
    const rightBox = document.querySelector('.block--right');
    rightBox.onclick = function() {
      const node = {x: this.dataset.x, y: this.dataset.y, z: this.dataset.z}
      const distance = 40;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
    }
  </script>
  <script src="js/menu.js"></script>
  <script src="js/snackbarToggle.js"></script>
</body>

</html>


