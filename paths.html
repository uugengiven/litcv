<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Divide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.1/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@1.9.2/dist/tsparticles.min.js"
    integrity="sha256-5kED68Spy7K2CEbfu4CjV92DmZR5ZQFUoIR5qmPzZWg=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="base.css" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="fonts/fonts.css" />
  <link rel="stylesheet" href="d3.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <script src="//unpkg.com/three"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <script src="js/paths-particles.js"></script>

</head>

<body onload="init()" class="gradient-body">
  <div class="particles gradient-body" id="tsparticles"></div>

  <!-- SITE HEADER -->
  <header>
    <h1 class="gt-america">Digital <span class="black-white">Divide</span></h1>
    <a href="#" class="menu-toggle">
      <svg width="50" height="50" viewBox="0 0 74 74" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="37" cy="37" r="37" fill="#E9EEF3" />
        <rect x="20" y="30" width="35" height="2" fill="#131313" class="menu-top" />
        <rect x="20" y="42" width="35" height="2" fill="#131313" class="menu-bottom" />
      </svg>
    </a>
  </header>

  <!-- MENU NAVIGATION -->
  <!-- These two nav tags are for the menu animation -->
  <nav class="fake-back"></nav>
  <nav class="fake-mid"></nav>

  <!-- Actual navigation -->
  <nav>
    <div class="internal">
      <a class="gt-america" href="characters.html">Characters</a>
      <a class="gt-america" href="story.html">Story</a>
      <a class="gt-america" href="cast.html">Cast and Crew</a>
      <a class="gt-america" href="news.html">News</a>
      <a class="gt-america" href="contact.html">Contact</a>
    </div>
    <div class="social">
      <a class="" href="#">Twitter</a>
      <a class="" href="#">Facebook</a>
      <a class="" href="#">Instagram</a>
    </div>
  </nav>
  </section>
  <section>
    <div id="3d-graph">
    </div>
  </section>
  <article class="snackbar_hidden" id="snackbar-container">
    <!-- temp tags until styled -->
    <img class="snackbar-icon" src="./images/icons/close-icon-circle.png" alt="close" title="close">
    <section class="diagonal-blocks">
      <div class="block block--left"></div>
      <div class="hamburger-btn hidden">
        <div class="hamburger"></div>
      </div>
      <section class="select-options hidden">
      </section>
      <div class="block block--right"></div>
    </section>
    <section class="snackbar-controls">
      <div>
        <span class="control-icon control-icon--prev material-icons-round" alt="back button icon" title="previous">arrow_back</span>
      </div>
      <div>
        <span class="control-icon control-icon--play material-icons-round" alt="play button icon" title="play">play_circle_outline</span>
      </div>
      <div>
        <span class="control-icon control-icon--next material-icons-round" alt="forward button icon" title="next">arrow_forward</span>
      </div>
    </section>
  </article>

  <script>
    const init = () => {
      particles();
    };
  </script>

  <script src="dd-data/episodes.js"></script>
  <!-- TODO: move to external file -->
  <script>
    // Selectors for snackbar and diagonal blocks inside snackbar
    const snackbar = document.getElementById('snackbar-container');
    const blockLeft = document.querySelector('.block--left');
    const blockRight = document.querySelector('.block--right');
    // Selectors for snack bar control icons
    const prevBtn = document.querySelector('.control-icon--prev');
    const nextBtn = document.querySelector('.control-icon--next');
    const playBtn = document.querySelector('.control-icon--play')
    // Selector for hamburger button in snackbar
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    var isHamburgerMenuOpen = false;
    // Selector for selector options in snackbar
    const selectOptions = document.querySelector('.select-options');
    // all nodes data
    var allNodes = data.nodes;
    // all links data
    const allLinks = data.links;
    // global vars because we need global access to these: (storyPath is path of episode links for each character)
    var storyPath = [];
    var storyPathIndex = 0;
    // id of characters associated with each episode
    var associatedCharacters = [];
    // objects for characters associated with each episode
    var filteredNodes = [];
    // current episode
    var currentEpisode = {};
    // container selector for dynamically added avatars in snackbar once episode node is clicked
    const avatarContainer = document.querySelector('.select-options');
    // Function increments through storyPath array and sets/resets classes based on position in array
    nextBtn.onclick = function() {
      // checks if last item of array
      if (storyPathIndex === (storyPath.length - 1)) {
        return;
      }
      // increment storyPath index
      storyPath[++storyPathIndex];
      // sets currentEpisode
      currentEpisode = storyPath[storyPathIndex].source;
      // removes active class on nextBtn if at last item in storyPath array
      storyPathIndex === (storyPath.length - 1) ? nextBtn.classList.remove('active') : null;
      // changes opacity for right text block in snackbar
      blockRight.classList.add('active');
      // changes opacity for play icon in snackbar
      playBtn.classList.add('active');
      // changes opacity for prev icon in snackbar
      prevBtn.classList.add('active');
      // removes pulse from nextBtn
      nextBtn.classList.remove('pulse');
      // removes character color from nextBtn icon
      nextBtn.removeAttribute('style');
      // shows hamburger button
      hamburgerBtn.classList.remove('hidden');
      // sets text content for episode in right diagonal block
      storyPathIndex !== 0 
      ? blockRight.textContent = storyPath[storyPathIndex].source.title 
      : blockRight.textContent = '' 
      & blockRight.classList.remove('active');
      if (storyPathIndex === 0) {
        nextBtn.classList.add('active');
        nextBtn.classList.add('pulse');
        nextBtn.style.color = storyPath[0].linkColor;
        prevBtn.classList.remove('active');
        playBtn.classList.remove('active');
        hamburgerBtn.classList.add('hidden');
      }
      // gets next target x,y,z and repositions camera
      let node = storyPath[storyPathIndex].source;
      const distance = 35;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
    }
    
    // Function decrements through storyPath array and sets/resets classes based on position in array
    prevBtn.onclick = function() {
      // checks if first item of array
      if (storyPathIndex === 0) {
        return;
      }
      if (storyPathIndex === 1) {
        // resets right block text if at first element of array and going back to character node
        blockRight.textContent = '';
        nextBtn.style.color = storyPath[0].linkColor;
        // sets currentEpisode
        currentEpisode = {};
      }
      // decrement storyPath index
      storyPath[--storyPathIndex];
      // sets currentEpisode
      currentEpisode = storyPath[storyPathIndex];
      // reset/set classes and text for snackbar blocks
      storyPathIndex === 0 
      ? blockRight.classList.remove('active') 
      & prevBtn.classList.remove('active')
      & playBtn.classList.remove('active')
      & nextBtn.classList.add('pulse')
      & hamburgerBtn.classList.add('hidden')
      : blockRight.textContent = storyPath[storyPathIndex].source.title;
      nextBtn.classList.add('active');
      
      // gets next target x,y,z and repositions camera
      let node = storyPath[storyPathIndex].source;
      const distance = 35;
      const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
    }

    // Function adds hamburger animation and toggles character path options 
    hamburgerBtn.addEventListener("click", () => {
      if(isHamburgerMenuOpen){
        isHamburgerMenuOpen = !isHamburgerMenuOpen;
        hamburgerBtn.classList.remove("open");
        selectOptions.classList.add('hidden')
        clearAvatars();
      }
      else {
        clearAvatars();
        // get associated characters
        associatedCharacters = currentEpisode.associatedCharacters;
        // filters associatedCharacters against allNodes to get characters objects needed
        filteredNodes = allNodes.filter(item => associatedCharacters.includes(item.id))
        // calls createAvatar function to create avatars in snackbar
        filteredNodes.forEach(function(item) {
          createAvatar(item.id, item.primaryColor, item.img, item.title)
        })
        // const associatedAvatars = document.querySelectorAll('.avatar');
        // associatedAvatars.forEach(item => item.addEventListener('click', chooseAvatar))
        isHamburgerMenuOpen = !isHamburgerMenuOpen;
        hamburgerBtn.classList.add("open");
        selectOptions.classList.remove('hidden');
      }
    });

    function chooseAvatar() {
      // gets id from selected avatar on click
      let selectedAvatarID = event.target.getAttribute('data-id');
      // gets name from selected avatar on click
      let selectedAvatarName = event.target.getAttribute('title');
      // sets left diagonal block to character name
      blockLeft.textContent = selectedAvatarName;
      // close hamburger and select options in snackbar
      isHamburgerMenuOpen = false;
      hamburgerBtn.classList.remove("open");
      selectOptions.classList.add('hidden')
      // builds character path array
      storyPath = allLinks.filter(item => item.characterPath === selectedAvatarID);
      // set storyPathIndex based on currentEpisode id index in latest storyPath
      storyPathIndex = storyPath.findIndex(item => item.source.id === currentEpisode.id);
      // set classes on prev/next buttons based on array index
      storyPathIndex !== 0 ? prevBtn.classList.add('active') : null;
      storyPathIndex !== (storyPath.length - 1) ? nextBtn.classList.add('active') : null;
      // sets left diagonal block to character color
      blockLeft.style.backgroundColor = storyPath[0].linkColor;
    }

    // dynamically creates avatars in snackbar
    function createAvatar(id, color, image, title) {
      const element = document.createElement('div');
      element.classList.add('avatar-container');
      element.innerHTML = `<img data-id="${id}" src="images/episodes/${image}" class="avatar" alt="Avatar" style="border: 3px solid ${color}" title=${title}>`;
      avatarContainer.appendChild(element);
      const associatedAvatars = document.querySelectorAll('.avatar');
      associatedAvatars.forEach(item => item.addEventListener('click', chooseAvatar))
    }

    // clears DOM of existing avatars
    function clearAvatars() {
      while(avatarContainer.hasChildNodes()) {
        avatarContainer.removeChild(avatarContainer.firstChild);
      }
    }

    function resetVariables() {
      // removes avatars if they exist
      clearAvatars();
      // resets storyPath index
      storyPathIndex = 0;
      // resets associated characters and filteredNodes
      associatedCharacters = [];
      filteredNodes = [];
      // toggle hamburger var
      isHamburgerMenuOpen = false;
    }

    // 3D graph 
    const elem = document.getElementById('3d-graph');
    const Graph = ForceGraph3D()
      (elem)
      .graphData(data)
      .backgroundColor('#ffffff00')
      .nodeLabel('title')
      .linkDirectionalParticles('value')
      .linkDirectionalParticleSpeed(.005)
      .linkColor('linkColor')
      .linkOpacity(1)
      .linkCurvature('linkCurvature')
      .linkCurveRotation('curveRotation')
      .linkDirectionalParticleWidth(1.125)
      .linkWidth('width')
      .linkResolution(6)
      .nodeThreeObject(({
        img,
        type,
        id,
        size
      }) => {
        const imgTexture = new THREE.TextureLoader().load(`./images/episodes/${img}`);
        const material = new THREE.SpriteMaterial({
          map: imgTexture
        });
        const sprite = new THREE.Sprite(material);
        if (type == "Character") {
          sprite.scale.set(size, size);
        } 
        else {
          sprite.scale.set(16, 9);
        }

        return sprite;
      })
      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
      // Aim at node from outside it
      .onNodeClick(node => {
        // checks to see if snackbar is open and toggles it
        snackbar.classList.contains('snackbar_hidden') ?
          snackbar.classList.remove('snackbar_hidden') & snackbar.classList.add('snackbar_show') :
          null;

        // conditional for character versus episode 
        if (node.type === "Character") {
          // clears all vars to original values
          resetVariables();
          // builds storyPath array based on node id and characterPath property in json
          storyPath = allLinks.filter(item => item.characterPath === node.id);
          // hide hamburger btn
          hamburgerBtn.classList.add('hidden');
          // toggle hamburger icon class
          hamburgerBtn.classList.remove('open');
          // hide snackbar select options
          selectOptions.classList.add('hidden')
          // resets classes on snackbar control icons
          prevBtn.classList.remove('active')
          playBtn.classList.remove('active')
          // adds active class to next button
          nextBtn.classList.add('active');
          // adds pulse animation to nextBtn
          nextBtn.classList.add('pulse');
          // adds character color to nextBtn
          nextBtn.style.color = node.primaryColor;
          // hides hamburger
          hamburgerBtn.classList.add('hidden')
          // resets for storyPathIndex and text content
          blockRight.classList.remove('active');
          blockRight.textContent = '';
          // Sets colors/text content for diagonal boxes in snackbar
          blockLeft.style.backgroundColor = node.primaryColor
          blockLeft.textContent = node.title;
        }
        if (node.type === "Episode") {
          // clears all vars to originals values
          resetVariables();
          // sets current episode to episode node clicked
          currentEpisode = node;
          // sets data atttribute of id on episode so it is accessible when finding index from avatar clicks
          blockRight.setAttribute('data-episodeID', node.id);
          // toggle hamburger icon class
          hamburgerBtn.classList.remove('open');
          // show hamburger button
          hamburgerBtn.classList.remove('hidden')
          // hide snackbar select options
          selectOptions.classList.add('hidden')
          // sets snackbar right box to episode title
          blockRight.textContent = node.title; 
          // resets snackbar left box to empty string
          blockLeft.textContent = 'Choose Path';
          // sets snackbar left box to default color
          blockLeft.style.backgroundColor = '#e2e2e2';
          // reset/set classes on snackbar right box and snackbar controls   
          blockRight.classList.add('active');         
          nextBtn.classList.remove('active');
          prevBtn.classList.remove('active');
          playBtn.classList.add('active');
          nextBtn.classList.remove('pulse');
          nextBtn.removeAttribute('style');
        }
        const distance = 35;
        const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
        Graph.cameraPosition({
            x: node.x * distRatio,
            y: node.y * distRatio,
            z: node.z * distRatio
          }, // new position
          node, // lookAt ({ x, y, z })
          2000 // ms transition duration
        );
      });
  </script>
  <script src="js/menu.js"></script>
  <script src="js/snackbarToggle.js"></script>
</body>
</html>

